{{- /*
    Using OSI definitions for Open Source: https://opensource.org/licenses
    Use SPDX IDs for licenses
*/ -}}

{{- $spdxSlice := slice -}}
{{- $path := "data/spdx.json" -}}
{{- with resources.Get $path -}}
  {{- with unmarshal .Content -}}
    {{- $spdxSlice = .licenses -}}
  {{- end -}}
{{- else -}}
  {{- errorf "Unable to get global resource %q" $path -}}
{{- end -}}

{{- $path = "data/spdx-extended.json" -}}
{{- with resources.Get $path -}}
  {{- with unmarshal .Content -}}
    {{- /* Update with some extra licenses */ -}}
    {{- $spdxSlice = append .licenses $spdxSlice -}}
  {{- end -}}
{{- else -}}
  {{- errorf "Unable to get global resource %q" $path -}}
{{- end -}}

{{- /* TODO: audit the list for the "share-alike" licenses */ -}}
{{- $viralSet := slice
  "GPL-2.0"
  "LGPL-3.0"
-}}

{{- $licenseData := slice -}}
{{- $anyOSIApproved := false -}}
{{- $allViralOSS := true -}}
{{- range $licenseSpdx := .Params.license.spdx -}}
  {{- $found := false -}}
  {{- range where $spdxSlice "licenseId" . -}}
    {{- $found = true -}}
    {{- $data := dict "name" .name "ref" .reference "isOsiApproved" .isOsiApproved -}}
    {{- $viral := in $viralSet .licenseId -}}
    {{- $data = merge $data (dict "viral" $viral) -}}
    {{- if .isOsiApproved -}}
      {{- $anyOSIApproved = true -}}
      {{- if $viral -}}
        {{- $data = merge $data (dict "licenseColor" "is-success" "licenseBlurb" "Copyleft") -}}
      {{- else -}}
        {{- $data = merge $data (dict "licenseColor" "is-info" "licenseBlurb" "Permissive Open Source") -}}
        {{- $allViralOSS = false -}}
      {{- end -}}
    {{- else -}}
      {{- $data = merge $data (dict "licenseColor" "is-danger" "licenseBlurb" "Not Open Source") -}}
      {{- $allViralOSS = false -}}
    {{- end -}}
    {{- $licenseData = $licenseData | append $data -}}
  {{- end -}}
  {{- if not $found -}}
    {{- errorf "Unable to find license %q" . -}}
  {{- end -}}
{{- end -}}

<section class="section is-small pl-0">
<h2 class="title is-3 mb-1">License</h2>

{{- $licenseTag := "" -}}
{{- $licenseSummary:= "" -}}
{{- $licenseRisk := "" -}}
{{- $licenseRiskLink := "/factor/license/" -}}
{{- $licenseColor := "" -}}
{{ if $anyOSIApproved }}
  {{ if $allViralOSS }}
    {{- $licenseTag = "Copyleft" -}}
    {{- $licenseSummary = "an open source and copyleft" -}}
    {{- $licenseRisk = "Low" -}}
    {{- $licenseColor = "is-success" -}}
  {{ else }}
    {{- $licenseTag = "Open Source" -}}
    {{- $licenseSummary = "an open source" -}}
    {{- $licenseRisk = "Medium" -}}
    {{- $licenseColor = "is-info" -}}
  {{ end }}
{{ else }}
  {{- $licenseTag = "Not Open Source" -}}
  {{- $licenseSummary = "no longer an open source" -}}
  {{- $licenseRisk = "High" -}}
  {{- $licenseColor = "is-danger" -}}
{{ end }}

<div class="field is-grouped is-grouped-multiline mb-5">
  <div class="control">
    <a class="tags has-addons" href="{{ $licenseRiskLink }}">
      <span class="tag is-info is-light">Risk</span>
      <span class="tag {{ $licenseColor }}">{{ $licenseRisk }}</span>
    </a>
  </div>
</div>

<p class="block">
{{ .Title }} is {{ $licenseSummary }} project.
It is released under the following licenses:
</p>

{{ range $licenseData }}
<p class="block ml-3">
	&#8227;
  &nbsp;
  <a href="{{ .ref }}">{{ .name }}</a>
  &nbsp;
  <span class="tag {{ .licenseColor }} is-light">{{ .licenseBlurb }}</span>
</p>
{{ end }}

<p class="block">
  <a href="{{ .Params.license.ref }}">Reference</a>
  &#124;
  <a href="{{ $licenseRiskLink }}">Learn more</a>
</p>
</section>
